# GitHub Actions Workflow for Continuous Deployment to AWS S3
# Deploys the React app to an S3 bucket when code is pushed to main branch

name: Deploy to AWS S3

on:
  # Runs on pushes to main branch after CI passes
  push:
    branches: ['main']

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# Permission for OIDC authentication with AWS
permissions:
  id-token: write
  contents: read

# Allow only one concurrent deployment
concurrency:
  group: 's3-deployment-${{ github.ref }}'
  cancel-in-progress: false

env:
  NODE_VERSION: '18'
  # AWS Configuration - Set these in GitHub Secrets
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  S3_BUCKET: ${{ vars.S3_BUCKET }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}

jobs:
  # Test job - ensure all tests pass before deployment
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

  # Build job
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:
          NODE_ENV: production
          VITE_APP_ENV: ${{ github.event.inputs.environment || 'production' }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 1

  # Deploy job
  deploy:
    name: Deploy to S3
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.get-url.outputs.website_url }}
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: dist/

      # Option 1: Using OIDC (Recommended - More Secure)
      # Requires setting up an IAM Identity Provider in AWS
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
        # If you prefer using Access Keys instead, comment out the above
        # and uncomment the section below

      # Option 2: Using Access Keys (Less Secure)
      # - name: Configure AWS credentials (Access Keys)
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ env.AWS_REGION }}

      - name: Sync files to S3
        run: |
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            --exclude "*.json"

      - name: Upload HTML files with no-cache
        run: |
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }} \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html" \
            --exclude "*" \
            --include "*.html"

      - name: Upload JSON files
        run: |
          aws s3 sync dist/ s3://${{ env.S3_BUCKET }} \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "application/json" \
            --exclude "*" \
            --include "*.json"

      - name: Invalidate CloudFront cache
        if: ${{ env.CLOUDFRONT_DISTRIBUTION_ID != '' }}
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Get website URL
        id: get-url
        run: |
          if [ -n "${{ env.CLOUDFRONT_DISTRIBUTION_ID }}" ]; then
            DOMAIN=$(aws cloudfront get-distribution --id ${{ env.CLOUDFRONT_DISTRIBUTION_ID }} --query 'Distribution.DomainName' --output text)
            echo "website_url=https://${DOMAIN}" >> $GITHUB_OUTPUT
          else
            echo "website_url=http://${{ env.S3_BUCKET }}.s3-website-${{ env.AWS_REGION }}.amazonaws.com" >> $GITHUB_OUTPUT
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**S3 Bucket:** ${{ env.S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Verify the deployment at your website URL" >> $GITHUB_STEP_SUMMARY
          echo "- Check CloudFront invalidation status (if applicable)" >> $GITHUB_STEP_SUMMARY

  # Cleanup job
  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Delete build artifact
        uses: geekyeggo/delete-artifact@v5
        with:
          name: build-files
